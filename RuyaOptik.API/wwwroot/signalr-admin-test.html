<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuyaOptik Admin SignalR Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1e1e1e; color: #fff; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .input-group { margin-bottom: 20px; background: #2d2d2d; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #aaa; }
        textarea { width: 100%; height: 80px; background: #333; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 8px; box-sizing: border-box; font-family: monospace; resize: vertical; }
        .btn-group { margin-top: 10px; display: flex; gap: 10px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        #btnConnect { background-color: #28a745; color: white; }
        #btnConnect:hover { background-color: #218838; }
        #btnConnect:disabled { background-color: #555; cursor: not-allowed; }
        #btnDisconnect { background-color: #dc3545; color: white; }
        #btnDisconnect:hover { background-color: #c82333; }
        #btnDisconnect:disabled { background-color: #555; cursor: not-allowed; }
        
        #status { margin-top: 10px; font-weight: bold; }
        .status-disconnected { color: #dc3545; }
        .status-connected { color: #28a745; }
        .status-connecting { color: #ffc107; }

        pre { background: #000; color: #0f0; padding: 15px; border-radius: 4px; height: 400px; overflow-y: auto; border: 1px solid #333; font-size: 14px; }
        .log-time { color: #888; margin-right: 10px; }
        .log-event { color: #0ff; }
        .log-error { color: #f00; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¡ RuyaOptik SignalR Admin Paneli</h2>
    
    <div class="input-group">
        <label for="hubUrl">Hub URL:</label>
        <input type="text" id="hubUrl" value="https://localhost:8081/hubs/orders" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #444; margin-bottom: 10px;">

        <label for="tokenInput">JWT Admin Token (Bearer):</label>
        <textarea id="tokenInput" placeholder="Login olduktan sonra aldÄ±ÄŸÄ±n token'Ä± buraya yapÄ±ÅŸtÄ±r..."></textarea>
        
        <div class="btn-group">
            <button id="btnConnect" onclick="connect()">ğŸ”Œ BaÄŸlan</button>
            <button id="btnDisconnect" onclick="disconnect()" disabled="">âŒ Kopar</button>
        </div>
        <div id="status" class="status-disconnected">Durum: ğŸ”´ BAÄLI DEÄÄ°L</div>
    </div>

    <h3>Olay GÃ¼nlÃ¼ÄŸÃ¼ (Logs)</h3>
    <pre id="logArea">Sistem hazÄ±r. Token girip baÄŸlanmayÄ± bekliyor...
<span class="log-time">[11:40:20 PM]</span> <span class="">BaÄŸlantÄ± baÅŸlatÄ±lÄ±yor...</span>
<span class="log-time">[11:40:21 PM]</span> <span class="log-event">SignalR baÄŸlantÄ±sÄ± baÅŸarÄ±yla kuruldu.</span>
<span class="log-time">[11:43:36 PM]</span> <span class="log-event">ğŸ”” YENÄ° SÄ°PARÄ°Å GELDÄ°!</span>
<span class="log-time">[11:43:36 PM]</span> <span class="">{
  "orderId": 4,
  "userId": "7d42f660-1179-40cd-89be-7df7bcfc63a7",
  "customerName": "Mehmet Ã‡akmak",
  "totalPrice": 2899,
  "createdDate": "2026-01-15T20:43:36.9268144Z"
}</span>
<span class="log-time">[12:06:34 AM]</span> <span class="log-error">BaÄŸlantÄ± koptu.</span></pre>
    <button onclick="clearLog()" style="background:#444; color:#fff; font-size:12px; padding:5px 10px;">LoglarÄ± Temizle</button>
</div>

<script>
    let connection = null;

    function log(message, type = 'info') {
        const logArea = document.getElementById("logArea");
        const time = new Date().toLocaleTimeString();
        let colorClass = '';
        if(type === 'event') colorClass = 'log-event';
        if(type === 'error') colorClass = 'log-error';

        logArea.innerHTML += `\n<span class="log-time">[${time}]</span> <span class="${colorClass}">${message}</span>`;
        logArea.scrollTop = logArea.scrollHeight; // Auto scroll
    }

    function clearLog() {
        document.getElementById("logArea").textContent = "Loglar temizlendi...";
    }

    function updateStatus(state) {
        const el = document.getElementById("status");
        const btnConnect = document.getElementById("btnConnect");
        const btnDisconnect = document.getElementById("btnDisconnect");

        if (state === 'connected') {
            el.textContent = "Durum: ğŸŸ¢ BAÄLANDI (Admin)";
            el.className = "status-connected";
            btnConnect.disabled = true;
            btnDisconnect.disabled = false;
        } else if (state === 'connecting') {
            el.textContent = "Durum: ğŸŸ¡ BAÄLANIYOR...";
            el.className = "status-connecting";
            btnConnect.disabled = true;
            btnDisconnect.disabled = true;
        } else {
            el.textContent = "Durum: ğŸ”´ BAÄLI DEÄÄ°L";
            el.className = "status-disconnected";
            btnConnect.disabled = false;
            btnDisconnect.disabled = true;
        }
    }

    async function connect() {
        const token = document.getElementById("tokenInput").value.trim();
        const url = document.getElementById("hubUrl").value.trim();

        if (!token) {
            log("HATA: LÃ¼tfen Ã¶nce bir Token yapÄ±ÅŸtÄ±rÄ±n!", "error");
            return;
        }

        updateStatus('connecting');
        log("BaÄŸlantÄ± baÅŸlatÄ±lÄ±yor...");

        try {
            connection = new signalR.HubConnectionBuilder()
                .withUrl(url, {
                    accessTokenFactory: () => token,
                    // Sertifika sorunu olursa (Localhost self-signed) bunu atlamak gerekebilir ama
                    // tarayÄ±cÄ±da zaten gÃ¼venli olarak iÅŸaretlediysen gerek kalmaz.
                })
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            // EVENT: Yeni SipariÅŸ GeldiÄŸinde
            connection.on("NewOrderCreated", (data) => {
                log("ğŸ”” YENÄ° SÄ°PARÄ°Å GELDÄ°!", "event");
                log(JSON.stringify(data, null, 2));
            });

            // BaÄŸlantÄ± KoptuÄŸunda
            connection.onclose(async () => {
                log("BaÄŸlantÄ± koptu.", "error");
                updateStatus('disconnected');
            });

            await connection.start();
            log("SignalR baÄŸlantÄ±sÄ± baÅŸarÄ±yla kuruldu.", "event");
            updateStatus('connected');

        } catch (err) {
            log("BAÄLANTI HATASI: " + err.toString(), "error");
            updateStatus('disconnected');
            console.error(err);
        }
    }

    async function disconnect() {
        if (connection) {
            await connection.stop();
            log("BaÄŸlantÄ± kullanÄ±cÄ± tarafÄ±ndan sonlandÄ±rÄ±ldÄ±.");
            updateStatus('disconnected');
        }
    }
</script>



</body>